<!DOCTYPE html>
<html>
<head>
    <title>SM Chat</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>

<div class="chat-container">
    <div class="header">
        ðŸ‘¤ {{ username }}
    </div>

    <div class="top-controls">
        <input id="receiver" placeholder="DM username">
        <input id="group" placeholder="Group name">
        <button onclick="joinGroup()">Join Group</button>
    </div>

    <div class="messages" id="chat"></div>

    <div class="input-box">
        <input id="msg" placeholder="Rubuta sako...">
        <button onclick="send()">âž¤</button>
    </div>
</div>

<script>
const socket = io();
const username = "{{ username }}";

function send() {
    const msg = document.getElementById("msg").value;
    const receiver = document.getElementById("receiver").value;
    const group = document.getElementById("group").value;

    if (!msg) return;

    if (group) {
        socket.emit("send_group_message", {
            sender: username,
            group: group,
            message: msg
        });
    } else if (receiver) {
        socket.emit("send_message", {
            sender: username,
            receiver: receiver,
            message: msg
        });
    }

    document.getElementById("msg").value = "";
}

function joinGroup() {
    const group = document.getElementById("group").value;
    if (!group) return;

    socket.emit("join_group", {
        username: username,
        group: group
    });
}

socket.on("receive_message", function(data) {
    if (data.sender === username || data.receiver === username) {
        addMsg(`${data.sender}: ${data.message}`, data.sender === username);
    }
});

socket.on("receive_group_message", function(data) {
    addMsg(`[${data.group}] ${data.sender}: ${data.message}`,
           data.sender === username);
});

socket.on("group_notice", function(data) {
    addSystemMsg(data.msg);
});

function addMsg(text, me) {
    const div = document.createElement("div");
    div.className = me ? "me" : "them";
    div.innerText = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function addSystemMsg(text) {
    const div = document.createElement("div");
    div.className = "system";
    div.innerText = text;
    chat.appendChild(div);
}
</script>

</body>
    </html>
