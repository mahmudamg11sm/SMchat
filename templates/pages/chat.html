{% extends "layout/base.html" %}
{% block content %}

<h2>
Chat with {{ friend }}
<span id="status"></span>
</h2>

<div id="typing" style="display:none;">Typing...</div>

<div class="chat-box" id="chatBox"></div>

<form id="chatForm">
  <input id="msgInput" placeholder="Type message..." autocomplete="off">
  <button type="submit">Send</button>
</form>

<button id="recordBtn">ðŸŽ¤ Record Voice</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>

<script>
const socket = io();
const currentUser = "{{ session['user'] }}";
const friend = "{{ friend }}";
const room = [currentUser, friend].sort().join("_");

socket.emit("join_room", {room: room});

const chatBox = document.getElementById("chatBox");
const input = document.getElementById("msgInput");

// SEND MESSAGE
document.getElementById("chatForm").onsubmit = e => {
  e.preventDefault();
  const msg = input.value;
  if(!msg) return;

  socket.emit("private_message", {to: friend, msg: msg});
  input.value="";
};

// RECEIVE MESSAGE
socket.on("private_message", data => {
  const div = document.createElement("div");
  div.innerHTML = `<b>${data.from}:</b> ${data.msg}
  <small>${data.status}</small>`;
  chatBox.appendChild(div);

  if(data.from !== currentUser){
    socket.emit("seen", {sender: data.from});
  }
});

// SEEN UPDATE
socket.on("message_seen", data => {
  const last = chatBox.lastElementChild;
  if(last) last.innerHTML += " âœ“âœ“ Seen";
});

// ONLINE STATUS
socket.on("user_status", data => {
  if(data.user === friend){
    document.getElementById("status").innerText =
      data.status === "online" ? " ðŸŸ¢ Online" : " âš« Offline";
  }
});

// TYPING
input.oninput = () => {
  socket.emit("typing", {to: friend});
};

socket.on("typing", data => {
  if(data.user !== currentUser){
    document.getElementById("typing").style.display="block";
    setTimeout(()=> {
      document.getElementById("typing").style.display="none";
    },2000);
  }
});
</script>

{% endblock %}
